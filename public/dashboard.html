<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Email Agent - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            gap: 0.5rem;
        }

        .logo-icon {
            font-size: 2rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: white;
            font-weight: 500;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        /* Main Layout */
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            min-height: calc(100vh - 100px);
        }

        /* Sidebar Navigation */
        .sidebar {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 120px;
        }

        .sidebar h3 {
            margin-bottom: 1.5rem;
            color: #667eea;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            color: #666;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-link:hover, .nav-link.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateX(5px);
        }

        .nav-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        /* Main Content Area */
        .main-content {
            display: grid;
            gap: 2rem;
        }

        /* Quick Stats Section */
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.12);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-icon {
            font-size: 2rem;
            padding: 0.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #333;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #28a745;
            margin-top: 0.5rem;
        }

        /* Content Sections */
        .content-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-title {
            font-size: 1.8rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-subtitle {
            color: #666;
            margin-top: 0.5rem;
            font-size: 0.95rem;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .quick-action {
            padding: 1.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .quick-action::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .quick-action:hover::before {
            left: 100%;
        }

        .quick-action:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .quick-action-icon {
            display: block;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-outline {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
        }

        /* Response Areas */
        .response-area {
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 1.5rem;
            min-height: 150px;
            font-family: inherit;
            margin: 1rem 0;
            line-height: 1.6;
            position: relative;
        }

        .response-area.loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            animation: loading-bar 2s infinite;
        }

        @keyframes loading-bar {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Checkbox styling */
        .email-checkbox, #select-all-emails {
            transform: scale(1.2);
            accent-color: #667eea;
            cursor: pointer;
        }
        
        /* Email List */
        .email-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            margin: 1rem 0;
            background: white;
        }

        .email-item {
            padding: 1rem;
            border-bottom: 1px solid #e1e5e9;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .email-item:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .email-item.selected {
            background: #e3f2fd;
            border-left: 4px solid #667eea;
        }

        .email-item.unread {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), rgba(255, 165, 0, 0.05));
            border-left: 3px solid #ffa500;
        }

        .email-subject {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #333;
        }

        .email-from {
            font-size: 0.9rem;
            color: #333;
            margin-bottom: 0.5rem;
            font-weight: 500; 
        }

        .email-preview {
            font-size: 0.85rem;
            color: #555;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .email-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: #666;
            font-weight: 500;
        }
        /* Move button styling */
        #move-selected-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #move-selected-btn:not(:disabled):hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        /* Controls section styling */
        #email-controls {
            border: 1px solid #e1e5e9;
        }
        
            /* Meeting Form */
        .meeting-form {
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 2rem;
            margin: 1rem 0;
            display: none;
        }

        .meeting-form.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Status Messages */
        .status-message {
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin: 1rem 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }

        /* Loading States */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Selected count styling */
        #selected-count {
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            background: #667eea;
            color: white;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        /* Logout Button */
        .logout-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 250px 1fr;
            }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #email-controls {
                flex-direction: column;
                gap: 0.75rem;
                align-items: stretch;
            }
    
            #email-controls > div {
                justify-content: center;
            }
        }
        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                padding: 1rem;
                gap: 1rem;
            }
            
            .sidebar {
                position: static;
                padding: 1rem;
            }
            
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }
            
            .stats-section {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .content-section {
                padding: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .dashboard-container {
                padding: 0.5rem;
            }
            
            .content-section {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .stat-card {
                padding: 1.5rem;
            }
            
            .quick-action {
                padding: 1rem;
            }
            /* 6. ADD this new CSS to improve section titles */
            .card h2 {
                margin-bottom: 1rem;
                color: #333; /* Ensure dark text */
                border-bottom: 2px solid #667eea;
                padding-bottom: 0.5rem;
                font-weight: 600; /* Make titles bolder */
            }
            
            /* 7. ADD this to improve form labels */
            input[type="text"], input[type="email"], input[type="datetime-local"], select, textarea {
                flex: 1;
                padding: 12px;
                border: 2px solid #e1e5e9;
                border-radius: 8px;
                font-size: 1rem;
                color: #333; /* Ensure dark text in form fields */
                background: white; /* Ensure white background */
            }
            
            /* 8. ADD this to improve response area text */
            .response-area {
                background: #f8f9fa;
                border: 1px solid #e1e5e9;
                border-radius: 8px;
                padding: 1rem;
                min-height: 150px;
                font-family: inherit;
                margin-bottom: 1rem;
                line-height: 1.6;
                color: #333; /* Ensure dark text */
            }
            
            /* 9. ADD this to improve loading text visibility */
            .loading {
                text-align: center;
                color: #333; /* Change from #6c757d to #333 */
                font-style: italic;
                font-weight: 500;
            }
            
            /* Force all text within containers to be white and readable */
            .content-section * {
                color: white !important;
            }
            
            .stat-card * {
                color: white !important;
            }
            
            .response-area {
                color: white !important;
                background: rgba(0, 0, 0, 0.7) !important;
                border: 2px solid #667eea !important;
            }
            
            /* Form elements */
            .form-input, .form-select, .form-textarea {
                color: white !important;
                background: rgba(0, 0, 0, 0.5) !important;
                border: 2px solid #667eea !important;
            }
            
            .form-input::placeholder,
            .form-select::placeholder,
            .form-textarea::placeholder {
                color: rgba(255, 255, 255, 0.7) !important;
            }
            
            .form-label {
                color: white !important;
                font-weight: 600 !important;
            }
            
            /* Email list items */
            .email-subject, .email-from, .email-preview, .email-meta {
                color: white !important;
            }
            
            /* Section titles and content */
            .section-title {
                color: white !important;
            }
            
            .section-subtitle {
                color: rgba(255, 255, 255, 0.8) !important;
            }
            
            /* Status messages */
            .status-message {
                color: white !important;
                background: rgba(0, 0, 0, 0.6) !important;
            }
            
            /* Quick actions text - keep white */
            .quick-action {
                color: white !important;
            }
            
            /* Ensure all paragraphs and divs in content sections are white */
            .content-section p,
            .content-section div,
            .content-section span,
            .content-section label {
                color: white !important;
            }
            
            /* Meeting form text */
            .meeting-form * {
                color: white !important;
            }
            
            .meeting-form {
                background: rgba(0, 0, 0, 0.6) !important;
            }
            
            /* Override any inherited text colors */
            body, html {
                color: white !important;
            }
            
            /* Dark backgrounds for contrast with white text */
            .content-section {
                background: rgba(0, 0, 0, 0.7) !important;
                color: white !important;
            }
            
            .stat-card {
                background: rgba(0, 0, 0, 0.7) !important;
                color: white !important;
            }
            
            /* Email list styling for white text */
            .email-list {
                background: rgba(0, 0, 0, 0.6) !important;
            }
            
            .email-item {
                background: rgba(0, 0, 0, 0.4) !important;
                border-bottom: 1px solid rgba(255, 255, 255, 0.2) !important;
            }
            
            .email-item:hover {
                background: rgba(0, 0, 0, 0.6) !important;
            }
            
            /* Sidebar white text */
            .sidebar * {
                color: white !important;
            }
            
            .sidebar {
                background: rgba(0, 0, 0, 0.7) !important;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
                color: #e0e0e0;
            }
            
            .sidebar, .content-section, .stat-card {
                background: #2a2a2a;
                color: #e0e0e0;
            }
            
            .form-input, .form-select, .form-textarea {
                background: #3a3a3a;
                border-color: #4a4a4a;
                color: #e0e0e0;
            }
            
            .response-area {
                background: #3a3a3a;
                border-color: #4a4a4a;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <span class="logo-icon">🤖📧</span>
            <span>AI Email Agent</span>
        </div>
        <div class="user-info">
            <div class="user-avatar">👤</div>
            <span id="user-name">Loading...</span>
            <a href="/auth/logout" class="logout-btn">Logout</a>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <h3>Navigation</h3>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" onclick="showSection('overview')">
                        <span class="nav-icon">📊</span>
                        <span>Overview</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('email-analyzer')">
                        <span class="nav-icon">🔍</span>
                        <span>Email Analyzer</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('email-responder')">
                        <span class="nav-icon">✍️</span>
                        <span>Email Responder</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('calendar-manager')">
                        <span class="nav-icon">📅</span>
                        <span>Calendar Manager</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('ai-assistant')">
                        <span class="nav-icon">🤖</span>
                        <span>AI Assistant</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('settings')">
                        <span class="nav-icon">⚙️</span>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Quick Stats -->
            <div class="stats-section">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">📧</div>
                    </div>
                    <div class="stat-value" id="total-emails">-</div>
                    <div class="stat-label">Total Emails Today</div>
                    <div class="stat-trend">
                        <span>📈</span>
                        <span>+12% from yesterday</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">📬</div>
                    </div>
                    <div class="stat-value" id="unread-emails">-</div>
                    <div class="stat-label">Unread Emails</div>
                    <div class="stat-trend">
                        <span>📉</span>
                        <span>-5% from yesterday</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">📅</div>
                    </div>
                    <div class="stat-value" id="today-meetings">-</div>
                    <div class="stat-label">Today's Meetings</div>
                    <div class="stat-trend">
                        <span>📊</span>
                        <span>3 upcoming</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">🎯</div>
                    </div>
                    <div class="stat-value">85%</div>
                    <div class="stat-label">Productivity Score</div>
                    <div class="stat-trend">
                        <span>📈</span>
                        <span>+8% this week</span>
                    </div>
                </div>
            </div>

            <!-- Overview Section -->
            <div id="overview-section" class="content-section active">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">
                            <span>📊</span>
                            Dashboard Overview
                        </h2>
                        <p class="section-subtitle">Your AI-powered email and calendar insights at a glance</p>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="quick-action" onclick="quickQuery('Summarize my emails from today')">
                        <span class="quick-action-icon">📊</span>
                        Today's Email Summary
                    </button>
                    <button class="quick-action" onclick="loadTodaySchedule()">
                        <span class="quick-action-icon">📅</span>
                        Today's Schedule
                    </button>
                    <button class="quick-action" onclick="quickQuery('Show me my unread emails')">
                        <span class="quick-action-icon">📬</span>
                        Unread Messages
                    </button>
                    <button class="quick-action" onclick="quickQuery('Check my availability tomorrow')">
                        <span class="quick-action-icon">🕒</span>
                        Tomorrow's Availability
                    </button>
                </div>

                <div class="response-area" id="overview-response">
                    Welcome to your AI Email Agent dashboard! 🚀
                    
                    <br><br><strong>Quick Start Guide:</strong>
                    <br>• Use the <strong>Email Analyzer</strong> to get intelligent insights about your messages
                    <br>• Try the <strong>Email Responder</strong> to generate AI-powered replies
                    <br>• Manage your schedule with the <strong>Calendar Manager</strong>
                    <br>• Ask questions to your <strong>AI Assistant</strong> for personalized help
                    
                    <br><br><em>Click any quick action above to get started!</em>
                </div>
            </div>

            <!-- Email Analyzer Section -->
            <div id="email-analyzer-section" class="content-section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">
                            <span>🔍</span>
                            Email Analyzer
                        </h2>
                        <p class="section-subtitle">Ask intelligent questions about your emails and get AI-powered insights</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Ask about your emails:</label>
                    <div style="display: flex; gap: 1rem;">
                        <input type="text" class="form-input" id="analyzer-query" 
                               placeholder="e.g., 'Show me emails about the project deadline'" 
                               style="flex: 1;">
                        <button class="btn btn-primary" onclick="analyzeEmails()">
                            <span>🔍</span>
                            Analyze
                        </button>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="quick-action" onclick="quickAnalyze('Summarize my emails from today')">
                        <span class="quick-action-icon">📊</span>
                        Daily Summary
                    </button>
                    <button class="quick-action" onclick="quickAnalyze('Find urgent emails')">
                        <span class="quick-action-icon">🚨</span>
                        Urgent Messages
                    </button>
                    <button class="quick-action" onclick="quickAnalyze('Show me emails with attachments')">
                        <span class="quick-action-icon">📎</span>
                        With Attachments
                    </button>
                    <button class="quick-action" onclick="quickAnalyze('Find meeting invitations')">
                        <span class="quick-action-icon">📅</span>
                        Meeting Invites
                    </button>
                </div>

                <div class="response-area" id="analyzer-response">
                    Enter a question about your emails above to get AI-powered insights and analysis.
                </div>
            </div>

            <!-- Email Responder Section -->
            <div id="email-responder-section" class="content-section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">
                            <span>✍️</span>
                            Email Responder
                        </h2>
                        <p class="section-subtitle">Generate professional AI-powered email responses</p>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="loadEmailsForResponse()" style="margin-bottom: 2rem;">
                    <span>📧</span>
                    Load Recent Emails
                </button>

                <div id="email-list-container" style="display: none;">
                    <h3 style="margin-bottom: 1rem;">Select an email to respond to:</h3>
                    <div id="email-list" class="email-list"></div>
                </div>

                <div id="response-form" style="display: none;">
                    <h3 style="margin-bottom: 1rem;">Generate Response</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Additional Context:</label>
                        <textarea class="form-textarea" id="response-context" 
                                  placeholder="Any additional context or specific points you want to address..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Response Tone:</label>
                        <select class="form-select" id="response-tone">
                            <option value="professional">Professional</option>
                            <option value="friendly">Friendly</option>
                            <option value="formal">Formal</option>
                            <option value="casual">Casual</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                        <button class="btn btn-primary" onclick="generateResponse()">
                            <span>🤖</span>
                            Generate Response
                        </button>
                        <button class="btn btn-outline" onclick="cancelResponse()">
                            Cancel
                        </button>
                    </div>
                </div>

                <div id="response-preview" style="display: none;">
                    <h3 style="margin-bottom: 1rem;">Generated Response</h3>
                    <div id="response-content" class="response-area"></div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-success" onclick="sendResponse()">
                            <span>📤</span>
                            Send Response
                        </button>
                        <button class="btn btn-outline" onclick="editResponse()">
                            Edit
                        </button>
                        <button class="btn btn-secondary" onclick="cancelResponse()">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Calendar Manager Section -->
            <div id="calendar-manager-section" class="content-section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">
                            <span>📅</span>
                            Calendar Manager
                        </h2>
                        <p class="section-subtitle">Intelligent calendar analysis and meeting scheduling</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Calendar Query:</label>
                    <div style="display: flex; gap: 1rem;">
                        <input type="text" class="form-input" id="calendar-query" 
                               placeholder="e.g., 'Schedule a team meeting next week'" 
                               style="flex: 1;">
                        <button class="btn btn-primary" onclick="analyzeCalendar()">
                            <span>📅</span>
                            Analyze
                        </button>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="quick-action" onclick="quickCalendar('Analyze my schedule for conflicts this week')">
                        <span class="quick-action-icon">🔍</span>
                        Find Conflicts
                    </button>
                    <button class="quick-action" onclick="quickCalendar('Best time for a 1-hour team meeting next week')">
                        <span class="quick-action-icon">👥</span>
                        Schedule Meeting
                    </button>
                    <button class="quick-action" onclick="quickCalendar('Show me my availability for client calls')">
                        <span class="quick-action-icon">📞</span>
                        Client Availability
                    </button>
                    <button class="quick-action" onclick="showMeetingForm()">
                        <span class="quick-action-icon">➕</span>
                        Create Meeting
                    </button>
                </div>

                <div class="response-area" id="calendar-response">
                    Ask questions about your calendar or use the quick actions above to get started.
                </div>

                <div id="meeting-form" class="meeting-form">
                    <h3 style="margin-bottom: 1.5rem;">Create Meeting Invite</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Meeting Title:</label>
                        <input type="text" class="form-input" id="meeting-title" placeholder="Enter meeting subject">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start Time:</label>
                            <input type="datetime-local" class="form-input" id="meeting-start">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Time:</label>
                            <input type="datetime-local" class="form-input" id="meeting-end">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Attendees (comma-separated emails):</label>
                        <input type="text" class="form-input" id="meeting-attendees" 
                               placeholder="email1@company.com, email2@company.com">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Meeting Type:</label>
                            <select class="form-select" id="meeting-type">
                                <option value="teams">Microsoft Teams</option>
                                <option value="zoom">Zoom Meeting</option>
                                <option value="in-person">In-Person</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Location:</label>
                            <input type="text" class="form-input" id="meeting-location" 
                                   placeholder="Conference Room or Meeting Link">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Agenda:</label>
                        <textarea class="form-textarea" id="meeting-agenda" 
                                  placeholder="Meeting agenda and objectives..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-success" onclick="createMeeting()">
                            <span>📅</span>
                            Create Meeting
                        </button>
                        <button class="btn btn-outline" onclick="hideMeetingForm()">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- AI Assistant Section -->
            <div id="ai-assistant-section" class="content-section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">
                            <span>🤖</span>
                            AI Assistant
                        </h2>
                        <p class="section-subtitle">Your personal AI assistant for email and calendar management</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Ask your AI assistant:</label>
                    <div style="display: flex; gap: 1rem;">
                        <input type="text" class="form-input" id="ai-query" 
                               placeholder="Ask anything about your emails, calendar, or productivity..." 
                               style="flex: 1;">
                        <button class="btn btn-primary" onclick="askAI()">
                            <span>🤖</span>
                            Ask AI
                        </button>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="quick-action" onclick="quickAI('What should I focus on today?')">
                        <span class="quick-action-icon">🎯</span>
                        Daily Focus
                    </button>
                    <button class="quick-action" onclick="quickAI('Help me prioritize my tasks')">
                        <span class="quick-action-icon">📋</span>
                        Prioritize Tasks
                    </button>
                    <button class="quick-action" onclick="quickAI('Suggest time blocks for deep work')">
                        <span class="quick-action-icon">⏰</span>
                        Time Blocking
                    </button>
                    <button class="quick-action" onclick="quickAI('How can I improve my email productivity?')">
                        <span class="quick-action-icon">📈</span>
                        Productivity Tips
                    </button>
                </div>

                <div class="response-area" id="ai-response">
                    Hi! I'm your AI assistant. Ask me anything about your emails, calendar, or how to improve your productivity. I can help you:
                    
                    <br><br>• Analyze your email patterns and suggest improvements
                    <br>• Find optimal times for meetings and focused work
                    <br>• Prioritize your tasks based on your schedule
                    <br>• Generate professional email responses
                    <br>• Detect meeting opportunities in your conversations
                    
                    <br><br>What would you like help with today?
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings-section" class="content-section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">
                            <span>⚙️</span>
                            Settings
                        </h2>
                        <p class="section-subtitle">Customize your AI Email Agent experience</p>
                    </div>
                </div>

                <div style="display: grid; gap: 2rem;">
                    <div>
                        <h3 style="margin-bottom: 1rem; color: #667eea;">AI Response Preferences</h3>
                        <div class="form-group">
                            <label class="form-label">Default Response Tone:</label>
                            <select class="form-select" id="default-tone">
                                <option value="professional">Professional</option>
                                <option value="friendly">Friendly</option>
                                <option value="formal">Formal</option>
                                <option value="casual">Casual</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Summary Frequency:</label>
                            <select class="form-select" id="summary-frequency">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="manual">Manual Only</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <h3 style="margin-bottom: 1rem; color: #667eea;">Calendar Preferences</h3>
                        <div class="form-group">
                            <label class="form-label">Default Meeting Duration:</label>
                            <select class="form-select" id="default-duration">
                                <option value="30">30 minutes</option>
                                <option value="60">1 hour</option>
                                <option value="90">1.5 hours</option>
                                <option value="120">2 hours</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Preferred Meeting Type:</label>
                            <select class="form-select" id="preferred-meeting-type">
                                <option value="teams">Microsoft Teams</option>
                                <option value="zoom">Zoom</option>
                                <option value="in-person">In-Person</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <h3 style="margin-bottom: 1rem; color: #667eea;">Notification Settings</h3>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" checked> Email summary notifications
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" checked> Meeting conflict alerts
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox"> Weekly productivity reports
                            </label>
                        </div>
                    </div>

                    <div style="padding-top: 2rem; border-top: 2px solid #f0f0f0;">
                        <button class="btn btn-primary" onclick="saveSettings()">
                            <span>💾</span>
                            Save Settings
                        </button>
                        <button class="btn btn-outline" onclick="resetSettings()" style="margin-left: 1rem;">
                            Reset to Defaults
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let selectedEmailId = null;
        let generatedResponse = null;

        // Initialize dashboard
        window.onload = function() {
            loadUserInfo();
            loadStats();
            showSection('overview');
        };

        // Navigation functions
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName + '-section').classList.add('active');
            
            // Add active class to corresponding nav link
            event.target.closest('.nav-link').classList.add('active');
        }

        // Load user information
        async function loadUserInfo() {
            try {
                const response = await fetch('/auth/user');
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    document.getElementById('user-name').textContent = data.user.name || data.user.username;
                } else {
                    window.location.href = '/auth/login';
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                document.getElementById('user-name').textContent = 'Error loading user';
            }
        }

        // Load dashboard statistics
        async function loadStats() {
            try {
                // Load email stats
                const emailResponse = await fetch('/api/emails?days=1');
                if (emailResponse.ok) {
                    const emailData = await emailResponse.json();
                    document.getElementById('total-emails').textContent = emailData.count;
                    document.getElementById('unread-emails').textContent = 
                        emailData.emails.filter(email => !email.isRead).length;
                }

                // Load calendar stats
                const calendarResponse = await fetch('/api/calendar/today');
                if (calendarResponse.ok) {
                    const calendarData = await calendarResponse.json();
                    document.getElementById('today-meetings').textContent = calendarData.eventCount || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Utility functions for formatting responses
        function formatResponse(text) {
            let html = text;
            
            // Convert headers
            html = html.replace(/^### (.*$)/gm, '<h3 style="color: #667eea; margin: 1rem 0 0.5rem 0;">$1</h3>');
            html = html.replace(/^## (.*$)/gm, '<h2 style="color: #333; margin: 1.5rem 0 0.5rem 0;">$1</h2>');
            html = html.replace(/^# (.*$)/gm, '<h1 style="color: #333; margin: 1.5rem 0 0.5rem 0;">$1</h1>');
            
            // Convert bold text
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong style="color: #495057;">$1</strong>');
            
            // Convert bullet points
            html = html.replace(/^[-•] (.*$)/gm, '<li style="margin: 0.25rem 0;">$1</li>');
            html = html.replace(/(<li>.*<\/li>)/gs, '<ul style="margin: 0.5rem 0; padding-left: 1.5rem;">$1</ul>');
            
            // Convert line breaks
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';
            html = html.replace(/<p><\/p>/g, '');
            
            return html;
        }

        function showLoading(elementId) {
            document.getElementById(elementId).innerHTML = 
                '<div style="text-align: center; padding: 2rem;"><div class="loading-spinner"></div><p style="margin-top: 1rem; color: #666;">Processing your request...</p></div>';
        }

        function showError(elementId, message) {
            document.getElementById(elementId).innerHTML = 
                `<div class="status-message status-error"><span>❌</span> ${message}</div>`;
        }

        function showSuccess(elementId, message) {
            document.getElementById(elementId).innerHTML = 
                `<div class="status-message status-success"><span>✅</span> ${message}</div>`;
        }

        // Overview section functions
        async function quickQuery(query) {
            showLoading('overview-response');
            
            try {
                const response = await fetch('/api/emails/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, includeDays: 7 })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('overview-response').innerHTML = formatResponse(data.response);
                } else {
                    const errorData = await response.json();
                    showError('overview-response', errorData.message || 'Failed to process query');
                }
            } catch (error) {
                console.error('Error processing query:', error);
                showError('overview-response', 'Failed to connect to AI service');
            }
        }

        async function loadTodaySchedule() {
            showLoading('overview-response');
            
            try {
                const response = await fetch('/api/calendar/today');
                if (response.ok) {
                    const data = await response.json();
                    
                    let scheduleHtml = `<h3 style="color: #667eea;">📅 Today's Schedule (${data.date})</h3>`;
                    scheduleHtml += `<p><strong>${data.eventCount} meetings scheduled</strong></p>`;
                    
                    if (data.events && data.events.length > 0) {
                        scheduleHtml += '<div style="margin-top: 1rem;">';
                        data.events.forEach((event, index) => {
                            scheduleHtml += `
                                <div style="background: #f8f9fa; padding: 1rem; margin: 0.5rem 0; border-radius: 8px; border-left: 4px solid #667eea;">
                                    <strong>${event.subject}</strong><br>
                                    <span style="color: #666;">🕒 ${event.displayTime || 'Time not specified'}</span><br>
                                    <span style="color: #666;">📍 ${event.location?.displayName || 'No location'}</span>
                                </div>
                            `;
                        });
                        scheduleHtml += '</div>';
                    } else {
                        scheduleHtml += '<p style="color: #28a745; margin-top: 1rem;">🎉 No meetings today! Great day for focused work.</p>';
                    }
                    
                    document.getElementById('overview-response').innerHTML = scheduleHtml;
                } else {
                    showError('overview-response', 'Failed to load schedule');
                }
            } catch (error) {
                console.error('Error loading schedule:', error);
                showError('overview-response', 'Failed to load today\'s schedule');
            }
        }

        // Email Analyzer functions
        async function analyzeEmails() {
            const query = document.getElementById('analyzer-query').value.trim();
            if (!query) {
                alert('Please enter a question about your emails');
                return;
            }

            showLoading('analyzer-response');
            
            try {
                const response = await fetch('/api/emails/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, includeDays: 7 })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('analyzer-response').innerHTML = formatResponse(data.response);
                } else {
                    const errorData = await response.json();
                    showError('analyzer-response', errorData.message || 'Failed to analyze emails');
                }
            } catch (error) {
                console.error('Error analyzing emails:', error);
                showError('analyzer-response', 'Failed to connect to AI service');
            }
        }

        function quickAnalyze(query) {
            document.getElementById('analyzer-query').value = query;
            analyzeEmails();
        }

        // Email Responder functions
        async function loadEmailsForResponse() {
            try {
                const response = await fetch('/api/emails?days=3');
                if (response.ok) {
                    const data = await response.json();
                    displayEmailList(data.emails);
                    document.getElementById('email-list-container').style.display = 'block';
                } else {
                    alert('Failed to load emails');
                }
            } catch (error) {
                console.error('Error loading emails:', error);
                alert('Failed to load emails');
            }
        }

        // ADD THESE FUNCTIONS TO YOUR EXISTING dashboard.html JavaScript section

// UPDATE your existing displayEmailList function to include checkboxes:
function displayEmailList(emails) {
    const emailList = document.getElementById('email-list');
    emailList.innerHTML = '';
    
    if (emails.length === 0) {
        emailList.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">No recent emails found</div>';
        return;
    }
    
    // Add "Select All" and "Move Selected" controls at the top
    const controlsDiv = document.createElement('div');
    controlsDiv.id = 'email-controls';
    controlsDiv.style.cssText = 'background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; justify-content: space-between;';
    controlsDiv.innerHTML = `
        <div style="display: flex; gap: 1rem; align-items: center;">
            <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #333;">
                <input type="checkbox" id="select-all-emails" onchange="toggleAllEmails(this.checked)">
                Select All Emails
            </label>
            <span id="selected-count" style="color: #666; font-size: 0.9rem;">0 selected</span>
        </div>
        <button id="move-selected-btn" class="btn btn-secondary" onclick="moveSelectedToTrash()" disabled>
            📁 Move Selected to Deleted Items
        </button>
    `;
    emailList.appendChild(controlsDiv);
    
    // Add each email with checkbox
    emails.forEach(email => {
        const emailItem = document.createElement('div');
        emailItem.className = 'email-item';
        emailItem.dataset.emailId = email.id;
        
        const unreadBadge = !email.isRead ? '🔵 ' : '';
        const attachmentBadge = email.hasAttachments ? '📎 ' : '';
        
        emailItem.innerHTML = `
            <div style="display: flex; align-items: flex-start; gap: 1rem;">
                <input type="checkbox" class="email-checkbox" value="${email.id}" onchange="updateSelectedCount()" style="margin-top: 0.5rem;">
                <div style="flex: 1; cursor: pointer;" onclick="selectEmail('${email.id}', this.closest('.email-item'), ${JSON.stringify(email).replace(/"/g, '&quot;')})">
                    <div class="email-subject">${unreadBadge}${attachmentBadge}${email.subject || 'No Subject'}</div>
                    <div class="email-from">From: ${email.from?.emailAddress?.name || email.from?.emailAddress?.address || 'Unknown'}</div>
                    <div class="email-preview">${email.bodyPreview || 'No preview available'}</div>
                    <div class="email-meta">
                        <span>${new Date(email.receivedDateTime).toLocaleDateString()}</span>
                        <span>${email.isRead ? 'Read' : 'Unread'}</span>
                    </div>
                </div>
            </div>
        `;
        
        emailList.appendChild(emailItem);
    });
}

// Function to toggle all email checkboxes
function toggleAllEmails(checked) {
    const checkboxes = document.querySelectorAll('.email-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = checked;
    });
    updateSelectedCount();
}

// Function to update the selected count and button state
function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.email-checkbox');
    const checkedBoxes = document.querySelectorAll('.email-checkbox:checked');
    
    const selectedCount = checkedBoxes.length;
    const totalCount = checkboxes.length;
    
    // Update count display
    document.getElementById('selected-count').textContent = `${selectedCount} selected`;
    
    // Update move button state
    const moveBtn = document.getElementById('move-selected-btn');
    moveBtn.disabled = selectedCount === 0;
    moveBtn.textContent = selectedCount > 0 ? `📁 Move ${selectedCount} to Deleted Items` : '📁 Move Selected to Deleted Items';
    
    // Update select all checkbox state
    const selectAllCheckbox = document.getElementById('select-all-emails');
    if (selectedCount === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (selectedCount === totalCount) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
    }
}

// Function to move selected emails to trash
async function moveSelectedToTrash() {
    const checkedBoxes = document.querySelectorAll('.email-checkbox:checked');
    const selectedEmailIds = Array.from(checkedBoxes).map(cb => cb.value);
    
    if (selectedEmailIds.length === 0) {
        alert('Please select emails to move to deleted items');
        return;
    }
    
    if (!confirm(`Move ${selectedEmailIds.length} selected emails to deleted items?`)) {
        return;
    }
    
    try {
        // Show loading state
        const moveBtn = document.getElementById('move-selected-btn');
        const originalText = moveBtn.textContent;
        moveBtn.innerHTML = '<span class="loading-spinner" style="display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></span> Moving emails...';
        moveBtn.disabled = true;
        
        const response = await fetch('/api/emails/move-selected-to-trash', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ emailIds: selectedEmailIds })
        });
        
        if (response.ok) {
            const data = await response.json();
            
            // Remove moved emails from the UI with animation
            selectedEmailIds.forEach(emailId => {
                const emailElement = document.querySelector(`[data-email-id="${emailId}"]`);
                if (emailElement) {
                    emailElement.style.transition = 'all 0.3s ease';
                    emailElement.style.opacity = '0.5';
                    emailElement.style.transform = 'translateX(50px)';
                    
                    setTimeout(() => {
                        emailElement.remove();
                        updateSelectedCount();
                        
                        // Check if any emails are left
                        const remainingEmails = document.querySelectorAll('.email-item').length - 1; // -1 for controls div
                        if (remainingEmails === 0) {
                            document.getElementById('email-list').innerHTML = 
                                '<div style="padding: 2rem; text-align: center; color: #666;">No emails remaining</div>';
                        }
                    }, 300);
                }
            });
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.style.cssText = 'background: #d4edda; color: #155724; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #c3e6cb;';
            successMsg.innerHTML = `✅ ${data.message}`;
            document.getElementById('email-responder-section').insertBefore(successMsg, document.getElementById('email-list-container'));
            
            // Remove success message after 5 seconds
            setTimeout(() => {
                if (successMsg.parentNode) {
                    successMsg.remove();
                }
            }, 5000);
            
            // Update stats
            loadStats();
            
        } else {
            const errorData = await response.json();
            alert(`Error: ${errorData.message || 'Failed to move emails to deleted items'}`);
        }
        
    } catch (error) {
        console.error('Error moving emails to trash:', error);
        alert('Failed to move emails to deleted items');
    } finally {
        // Restore button state
        const moveBtn = document.getElementById('move-selected-btn');
        updateSelectedCount(); // This will restore the proper button text and state
    }
}

        function selectEmail(emailId, element, emailData) {
            // Remove previous selection
            document.querySelectorAll('.email-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Select current email
            element.classList.add('selected');
            selectedEmailId = emailId;
            
            // Show response form
            document.getElementById('response-form').style.display = 'block';
        }

        async function generateResponse() {
            if (!selectedEmailId) {
                alert('Please select an email first');
                return;
            }
            
            const context = document.getElementById('response-context').value;
            const tone = document.getElementById('response-tone').value;
            
            showLoading('response-content');
            document.getElementById('response-preview').style.display = 'block';
            
            try {
                const response = await fetch(`/api/emails/${selectedEmailId}/respond`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ context, tone })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    generatedResponse = data;
                    
                    document.getElementById('response-content').innerHTML = `
                        <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <strong>To:</strong> ${data.originalFrom}<br>
                            <strong>Subject:</strong> ${data.suggestedSubject}
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 2px solid #e1e5e9;">
                            <h4 style="margin-bottom: 1rem; color: #333;">Generated Response:</h4>
                            <div style="white-space: pre-wrap; line-height: 1.6;">${data.generatedResponse}</div>
                        </div>
                    `;
                } else {
                    const errorData = await response.json();
                    showError('response-content', errorData.message || 'Failed to generate response');
                }
            } catch (error) {
                console.error('Error generating response:', error);
                showError('response-content', 'Failed to generate email response');
            }
        }

        async function sendResponse() {
            if (!generatedResponse) {
                alert('No response to send');
                return;
            }
            
            try {
                const response = await fetch(`/api/emails/${selectedEmailId}/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        responseContent: generatedResponse.generatedResponse,
                        subject: generatedResponse.suggestedSubject
                    })
                });
                
                if (response.ok) {
                    showSuccess('response-content', 'Email sent successfully!');
                    setTimeout(() => {
                        cancelResponse();
                    }, 2000);
                } else {
                    const errorData = await response.json();
                    showError('response-content', errorData.message || 'Failed to send email');
                }
            } catch (error) {
                console.error('Error sending email:', error);
                showError('response-content', 'Failed to send email');
            }
        }

        function editResponse() {
            if (!generatedResponse) return;
            
            const responseText = generatedResponse.generatedResponse;
            document.getElementById('response-content').innerHTML = `
                <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <strong>To:</strong> ${generatedResponse.originalFrom}<br>
                    <strong>Subject:</strong> ${generatedResponse.suggestedSubject}
                </div>
                <div style="margin-bottom: 1rem;">
                    <label class="form-label">Edit Response:</label>
                    <textarea id="edit-response-text" class="form-textarea" style="min-height: 200px;">${responseText}</textarea>
                </div>
                <button class="btn btn-primary" onclick="updateResponse()">Update Response</button>
            `;
        }

        function updateResponse() {
            const newText = document.getElementById('edit-response-text').value;
            generatedResponse.generatedResponse = newText;
            
            document.getElementById('response-content').innerHTML = `
                <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <strong>To:</strong> ${generatedResponse.originalFrom}<br>
                    <strong>Subject:</strong> ${generatedResponse.suggestedSubject}
                </div>
                <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 2px solid #e1e5e9;">
                    <h4 style="margin-bottom: 1rem; color: #333;">Updated Response:</h4>
                    <div style="white-space: pre-wrap; line-height: 1.6;">${newText}</div>
                </div>
            `;
        }

        function cancelResponse() {
            document.getElementById('response-form').style.display = 'none';
            document.getElementById('response-preview').style.display = 'none';
            document.getElementById('email-list-container').style.display = 'none';
            
            // Clear selections and reset
            document.querySelectorAll('.email-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            selectedEmailId = null;
            generatedResponse = null;
            
            // Clear form fields
            document.getElementById('response-context').value = '';
            document.getElementById('response-tone').value = 'professional';
        }

        // Calendar Manager functions
        async function analyzeCalendar() {
            const query = document.getElementById('calendar-query').value.trim();
            if (!query) {
                alert('Please enter a calendar query');
                return;
            }

            showLoading('calendar-response');
            
            try {
                const response = await fetch('/api/calendar/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('calendar-response').innerHTML = formatResponse(data.analysis);
                    
                    // Check for meeting suggestions
                    if (data.meetingData && data.meetingData.meetingDetected) {
                        showMeetingSuggestion(data.meetingData.meetingDetails);
                    }
                } else {
                    const errorData = await response.json();
                    showError('calendar-response', errorData.message || 'Failed to analyze calendar');
                }
            } catch (error) {
                console.error('Error analyzing calendar:', error);
                showError('calendar-response', 'Failed to analyze calendar');
            }
        }

        function quickCalendar(query) {
            document.getElementById('calendar-query').value = query;
            analyzeCalendar();
        }

        function showMeetingSuggestion(meetingDetails) {
            const suggestionHtml = `
                <div style="background: #e8f5e8; border: 2px solid #4caf50; border-radius: 12px; padding: 1.5rem; margin-top: 1rem;">
                    <h4 style="color: #2e7d32; margin: 0 0 1rem 0;">🤖 AI Meeting Suggestion Detected!</h4>
                    <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <p><strong>Meeting:</strong> ${meetingDetails.title}</p>
                        <p><strong>Duration:</strong> ${meetingDetails.duration} minutes</p>
                        <p><strong>Attendees:</strong> ${meetingDetails.attendees ? meetingDetails.attendees.join(', ') : 'None specified'}</p>
                        <p><strong>Type:</strong> ${meetingDetails.meetingType}</p>
                        <p><strong>Description:</strong> ${meetingDetails.description}</p>
                    </div>
                    <button class="btn btn-success" onclick="applyMeetingSuggestion()">📅 Apply Suggestion</button>
                    <button class="btn btn-outline" onclick="dismissSuggestion()" style="margin-left: 0.5rem;">❌ Dismiss</button>
                </div>
            `;
            
            document.getElementById('calendar-response').innerHTML += suggestionHtml;
            window.currentMeetingSuggestion = meetingDetails;
        }

        function applyMeetingSuggestion() {
            if (!window.currentMeetingSuggestion) return;
            
            const details = window.currentMeetingSuggestion;
            document.getElementById('meeting-title').value = details.title;
            document.getElementById('meeting-attendees').value = details.attendees ? details.attendees.join(', ') : '';
            document.getElementById('meeting-agenda').value = details.description;
            
            showMeetingForm();
        }

        function dismissSuggestion() {
            window.currentMeetingSuggestion = null;
            // Remove suggestion from DOM
            const suggestions = document.querySelectorAll('[style*="background: #e8f5e8"]');
            suggestions.forEach(s => s.remove());
        }

        function showMeetingForm() {
            document.getElementById('meeting-form').classList.add('active');
            
            // Set default times
            const now = new Date();
            const oneHour = new Date(now.getTime() + 60 * 60 * 1000);
            
            document.getElementById('meeting-start').value = now.toISOString().slice(0, 16);
            document.getElementById('meeting-end').value = oneHour.toISOString().slice(0, 16);
        }

        function hideMeetingForm() {
            document.getElementById('meeting-form').classList.remove('active');
            
            // Clear form
            document.getElementById('meeting-title').value = '';
            document.getElementById('meeting-attendees').value = '';
            document.getElementById('meeting-location').value = '';
            document.getElementById('meeting-agenda').value = '';
        }

        async function createMeeting() {
            const title = document.getElementById('meeting-title').value.trim();
            const startTime = document.getElementById('meeting-start').value;
            const endTime = document.getElementById('meeting-end').value;
            const attendeesStr = document.getElementById('meeting-attendees').value.trim();
            const location = document.getElementById('meeting-location').value.trim();
            const agenda = document.getElementById('meeting-agenda').value.trim();
            const meetingType = document.getElementById('meeting-type').value;
            
            if (!title || !startTime || !endTime) {
                alert('Please fill in the required fields (title, start time, end time)');
                return;
            }
            
            const attendees = attendeesStr ? attendeesStr.split(',').map(email => email.trim()).filter(email => email) : [];
            
            try {
                const response = await fetch('/api/calendar/create-invite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title, startTime: new Date(startTime).toISOString(),
                        endTime: new Date(endTime).toISOString(),
                        attendees, location, agenda, meetingType
                    })
                });
                
                if (response.ok) {
                    showSuccess('calendar-response', 'Meeting invite created successfully! 🎉');
                    hideMeetingForm();
                    loadStats();
                } else {
                    const errorData = await response.json();
                    showError('calendar-response', errorData.message || 'Failed to create meeting');
                }
            } catch (error) {
                console.error('Error creating meeting:', error);
                showError('calendar-response', 'Failed to create meeting invite');
            }
        }

        // AI Assistant functions
        async function askAI() {
            const query = document.getElementById('ai-query').value.trim();
            if (!query) {
                alert('Please enter a question for your AI assistant');
                return;
            }

            showLoading('ai-response');
            
            try {
                const response = await fetch('/api/emails/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, includeDays: 7 })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('ai-response').innerHTML = formatResponse(data.response);
                } else {
                    const errorData = await response.json();
                    showError('ai-response', errorData.message || 'Failed to process request');
                }
            } catch (error) {
                console.error('Error asking AI:', error);
                showError('ai-response', 'Failed to connect to AI assistant');
            }
        }

        function quickAI(query) {
            document.getElementById('ai-query').value = query;
            askAI();
        }

        // Settings functions
        function saveSettings() {
            // In a real app, this would save to a backend
            showSuccess('settings-section', 'Settings saved successfully!');
            
            // Store settings in localStorage for demo
            const settings = {
                defaultTone: document.getElementById('default-tone').value,
                summaryFrequency: document.getElementById('summary-frequency').value,
                defaultDuration: document.getElementById('default-duration').value,
                preferredMeetingType: document.getElementById('preferred-meeting-type').value
            };
            
            localStorage.setItem('ai-email-agent-settings', JSON.stringify(settings));
        }

        function resetSettings() {
            document.getElementById('default-tone').value = 'professional';
            document.getElementById('summary-frequency').value = 'daily';
            document.getElementById('default-duration').value = '60';
            document.getElementById('preferred-meeting-type').value = 'teams';
            
            localStorage.removeItem('ai-email-agent-settings');
            showSuccess('settings-section', 'Settings reset to defaults');
        }

        // Load saved settings on page load
        function loadSettings() {
            const saved = localStorage.getItem('ai-email-agent-settings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('default-tone').value = settings.defaultTone || 'professional';
                document.getElementById('summary-frequency').value = settings.summaryFrequency || 'daily';
                document.getElementById('default-duration').value = settings.defaultDuration || '60';
                document.getElementById('preferred-meeting-type').value = settings.preferredMeetingType || 'teams';
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter to submit forms
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                const activeSection = document.querySelector('.content-section.active');
                const activeInput = document.activeElement;
                
                if (activeInput.id === 'analyzer-query') {
                    analyzeEmails();
                } else if (activeInput.id === 'calendar-query') {
                    analyzeCalendar();
                } else if (activeInput.id === 'ai-query') {
                    askAI();
                }
            }
        });

        // Auto-refresh stats every 5 minutes
        setInterval(loadStats, 5 * 60 * 1000);

        // Load settings when page loads
        setTimeout(loadSettings, 100);
    </script>
</body>
</html>
